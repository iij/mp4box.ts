import { Mp4Box} from "../";
import { SampleParams } from "../types";

// ISO/IEC 14496-12 8.2.2
export function make(mp4box: Mp4Box, params: SampleParams | SampleParams[] | undefined = undefined): Uint8Array {
    params = params as SampleParams;
    const UINT32_MAX = Math.pow(2, 32) - 1;
    const timescale = mp4box.timescale;
    if (params.duration == undefined) {
	throw new Error("need duration");
    }
    const duration = params.duration * timescale;
    const upperword = Math.floor(duration / (UINT32_MAX + 1));
    const lowerword = Math.floor(duration % (UINT32_MAX + 1));
    return Uint8Array.from([
	0x01, // version 1
	0x00,
	0x00,
	0x00, // flags
	0x00,
	0x00,
	0x00,
	0x00,
	0x00,
	0x00,
	0x00,
	0x02, // creation_time
	0x00,
	0x00,
	0x00,
	0x00,
	0x00,
	0x00,
	0x00,
	0x03, // modification_time
	(timescale >> 24) & 0xff,
	(timescale >> 16) & 0xff,
	(timescale >> 8) & 0xff,
	timescale & 0xff, // timescale
	upperword >> 24,
	(upperword >> 16) & 0xff,
	(upperword >> 8) & 0xff,
	upperword & 0xff,
	lowerword >> 24,
	(lowerword >> 16) & 0xff,
	(lowerword >> 8) & 0xff,
	lowerword & 0xff,
	0x00, 0x01, 0x00, 0x00, // rate
	0x01, 0x00, // volume
	0x00, 0x00, // reserved
	0x00, 0x00, 0x00, 0x00, // reserved[0]
	0x00, 0x00, 0x00, 0x00, // reserved[1]
	0x00, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x01, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x40, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0xff, 0xff, 0xff, 0xff,
    ]);
}
